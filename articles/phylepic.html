<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="phylepic">
<title>phylepic charts: combining phylogenetic trees with epidemic curves • phylepic</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="phylepic charts: combining phylogenetic trees with epidemic curves">
<meta property="og:description" content="phylepic">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">phylepic</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/phylepic.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/cidm-ph/phylepic/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>phylepic charts: combining phylogenetic trees with epidemic curves</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cidm-ph/phylepic/blob/HEAD/vignettes/phylepic.Rmd" class="external-link"><code>vignettes/phylepic.Rmd</code></a></small>
      <div class="d-none name"><code>phylepic.Rmd</code></div>
    </div>

    
    
<p>This document steps through creating and customising phylepic charts
using an example dataset.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cidm-ph/phylepic" class="external-link">phylepic</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/emmanuelparadis/ape" class="external-link">ape</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="preparing-the-data">Preparing the data<a class="anchor" aria-label="anchor" href="#preparing-the-data"></a>
</h2>
<p>This example uses a real tree from a foodborne enteric pathogen. The
tree is loaded in from a Newick file using the <code>ape</code>
package:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/ape/man/read.tree.html" class="external-link">read.tree</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"enteric.newick"</span>, package <span class="op">=</span> <span class="st">"phylepic"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">tree</span><span class="op">)</span></span></code></pre></div>
<p><img src="phylepic_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>The tree comes with some metadata that has been manipulated for
illustration. The metadata includes a name and collection date for the
samples, whether they are environmental or clinical isolates (if known),
and a label for any isolates that were assigned to a genomic cluster.
These are read in from a CSV file:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"enteric_metadata.csv"</span>, package <span class="op">=</span> <span class="st">"phylepic"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">metadata</span><span class="op">)</span></span>
<span><span class="co">#&gt;       name collection_date source  cluster</span></span>
<span><span class="co">#&gt; 1 NSW-0004      2013-02-18   &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 2 NSW-0020      2016-11-19   &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 3 NSW-0029      2017-01-13   &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 4 NSW-0042      2017-02-28   &lt;NA&gt;     &lt;NA&gt;</span></span>
<span><span class="co">#&gt; 5 NSW-0051      2017-11-20   &lt;NA&gt; Clust-01</span></span>
<span><span class="co">#&gt; 6 NSW-0054      2017-12-23   &lt;NA&gt;     &lt;NA&gt;</span></span></code></pre></div>
<p>The only requirements here are that we have a column that corresponds
to the tip labels from the tree (here called <code>name</code>), and one
that has dates represented as <code>Date</code> objects. We’ll also
indicate the two columns with categorical data by converting them to
factors:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">metadata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>  <span class="va">metadata</span>,</span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">source</span>, <span class="va">cluster</span><span class="op">)</span>, <span class="va">factor</span><span class="op">)</span>,</span>
<span>  collection_date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="va">collection_date</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="basic-plotting">Basic plotting<a class="anchor" aria-label="anchor" href="#basic-plotting"></a>
</h2>
<p>To start with, we can pull out one clade from the tree to make a
small plot:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clade.parent</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/mrca.html" class="external-link">getMRCA</a></span><span class="op">(</span><span class="va">tree</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"NSW-0324"</span>, <span class="st">"NSW-0330"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">clade</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/drop.tip.html" class="external-link">extract.clade</a></span><span class="op">(</span><span class="va">tree</span>, <span class="va">clade.parent</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">clade</span><span class="op">)</span></span></code></pre></div>
<p><img src="phylepic_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>The <code><a href="../reference/phylepic.html">phylepic()</a></code> function joins a tree with its metadata
and does some consistency checks. The resulting <code>phylepic</code>
object has a plot method that guesses sensible defaults:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/phylepic.html">phylepic</a></span><span class="op">(</span><span class="va">clade</span>, <span class="va">metadata</span>, <span class="va">name</span>, <span class="va">collection_date</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 1 row containing non-finite outside the scale range (`stat_week()`).</span></span>
<span><span class="co">#&gt; Removed 1 row containing non-finite outside the scale range (`stat_week()`).</span></span></code></pre></div>
<p><img src="phylepic_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>Metadata bars were added for all factor columns in the metadata
frame, with different categorical colour scales. The dates were binned
by week to give an epidemic curve in the upper right. The calendar panel
in the lower right has the same weekly binning so that you can scan
across from a tip on the tree and follow it up to the epidemic curve to
find the collection date.</p>
</div>
<div class="section level2">
<h2 id="customising-the-plot">Customising the plot<a class="anchor" aria-label="anchor" href="#customising-the-plot"></a>
</h2>
<p>Looking to the full dataset instead of just that single clade, the
default plot needs some configuration to be useful:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phydata</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/phylepic.html">phylepic</a></span><span class="op">(</span><span class="va">tree</span>, <span class="va">metadata</span>, <span class="va">name</span>, <span class="va">collection_date</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phydata</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 7 rows containing non-finite outside the scale range (`stat_week()`).</span></span>
<span><span class="co">#&gt; Removed 7 rows containing non-finite outside the scale range (`stat_week()`).</span></span></code></pre></div>
<p><img src="phylepic_files/figure-html/unnamed-chunk-8-1.png" width="1056"></p>
<div class="section level3">
<h3 id="the-date-scale">The date scale<a class="anchor" aria-label="anchor" href="#the-date-scale"></a>
</h3>
<p>We can choose the first day of the week to match the local
conventions:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>phylepic.week_start <span class="op">=</span> <span class="st">"Monday"</span><span class="op">)</span></span></code></pre></div>
<p>The date range is too big for this type of chart, so we want to focus
in on a time period near the outbreak clusters Clust-04 and Clust-05. By
using <code>scale_x_week</code>, we get some conveniences such as being
able to specify the breaks (tick labels) in intervals of weeks:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">date_scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/scale_x_week.html">scale_x_week</a></span><span class="op">(</span></span>
<span>  name <span class="op">=</span> <span class="st">"Date of sample collection"</span>,</span>
<span>  limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html" class="external-link">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"2023-08-14"</span>, <span class="st">"2023-11-15"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  date_labels <span class="op">=</span> <span class="st">"%d %b"</span>,</span>
<span>  week_breaks <span class="op">=</span> <span class="fl">4L</span>,</span>
<span>  week_minor_breaks <span class="op">=</span> <span class="fl">2L</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can also control the relative heights of the two rows of panels in
the final grid using <code>height.tree</code> (choosing here to make is
6 times the height of the epidemic curve). Our date scale is passed to
both the relevant panels:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">phydata</span>, scale.date <span class="op">=</span> <span class="va">date_scale</span>, height.tree <span class="op">=</span> <span class="fl">6</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Removed 28 rows containing non-finite outside the scale range (`stat_week()`).</span></span>
<span><span class="co">#&gt; Removed 28 rows containing non-finite outside the scale range (`stat_week()`).</span></span></code></pre></div>
<p><img src="phylepic_files/figure-html/unnamed-chunk-11-1.png" width="1056"></p>
<p>Note that dates outside our chosen date limits are drawn on the
calendar as triangles at the corresponding edge of the scale. Some rows
are missing date metadata, so this allows us to distinguish them
visually. This feature is enabled by the default <code>oob</code> (out
of bounds) argument to <code>scale_x_week</code>.</p>
</div>
<div class="section level3">
<h3 id="manipulating-the-tree">Manipulating the tree<a class="anchor" aria-label="anchor" href="#manipulating-the-tree"></a>
</h3>
<p>It would be nice to represent the genomic clusters using colours on
the tree tips instead of a separate column of metadata tiles, since
genomic clusters are based on the tree structure. The tree is drawn
using ggraph and its dendrogram layout. In order to add a new layer of
tip dots, we need to intercept the <code>ggraph</code> plot before it’s
assembled into the final chart.</p>
<p>Firstly, let’s manually define a colour scale for the clusters so
that we can have it be consistent between panels:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cluster_scale</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_colour_brewer</a></span><span class="op">(</span></span>
<span>  <span class="co"># the name affects the legend title</span></span>
<span>  name <span class="op">=</span> <span class="st">"Cluster"</span>,</span>
<span>  <span class="co"># these 3 parameters affect the colour choice</span></span>
<span>  type <span class="op">=</span> <span class="st">"qual"</span>,</span>
<span>  palette <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  direction <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>  <span class="co"># don't drop unused levels; we want consistency between panels</span></span>
<span>  drop <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="co"># suppress the explicit NA entry in the legend; not all tips are in a cluster</span></span>
<span>  na.translate <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  <span class="co"># we'll use this scale later for both fill and colour aesthetics</span></span>
<span>  aesthetics <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fill"</span>, <span class="st">"colour"</span><span class="op">)</span>,</span>
<span>  <span class="co"># make the dots on the legend bigger so we can see the colours</span></span>
<span>  guide <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html" class="external-link">guide_legend</a></span><span class="op">(</span>override.aes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>To manipulate the tree, we use <code>plot_tree</code>, which creates
the base plot to which we can add our new layers:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot_tree.html">plot_tree</a></span><span class="op">(</span><span class="va">phydata</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># `filter = leaf` in ggraph geoms means that they only draw the tips</span></span>
<span>  <span class="fu">ggraph</span><span class="fu">::</span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_point.html" class="external-link">geom_node_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="va">leaf</span>, colour <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">cluster_scale</span></span>
<span><span class="co">#&gt; Warning: Duplicated `override.aes` is ignored.</span></span>
<span><span class="co">#&gt; Warning: Removed 11 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span></code></pre></div>
<p><img src="phylepic_files/figure-html/unnamed-chunk-13-1.png" width="700"></p>
<p>All of the columns from our metadata frame are available (for the
tips) to use in ggraph’s aesthetic mappings.</p>
<p>Next, we’ll want to hide the redundant coloured tiles describing the
cluster. To do this, we use <code>plot_bars</code> to override the
default behaviour of creating a bar for each factor in the metadata
frame. This helper takes arguments in the form
<code>&lt;column name&gt; = &lt;scale definition&gt;</code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">phydata</span>,</span>
<span>  plot.tree <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># this function will be called with x = phydata</span></span>
<span>    <span class="fu"><a href="../reference/plot_tree.html">plot_tree</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggraph</span><span class="fu">::</span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_point.html" class="external-link">geom_node_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="va">leaf</span>, colour <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="va">cluster_scale</span></span>
<span>  <span class="op">}</span>,</span>
<span>  plot.bars <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/plot_bars.html">plot_bars</a></span><span class="op">(</span></span>
<span>      <span class="va">x</span>,</span>
<span>      <span class="co"># 'source' is the name of the corresponding metadata column</span></span>
<span>      source <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html" class="external-link">scale_fill_hue</a></span><span class="op">(</span></span>
<span>        name <span class="op">=</span> <span class="st">"Source"</span>,</span>
<span>        <span class="co"># this just changes the colours</span></span>
<span>        h.start <span class="op">=</span> <span class="fl">30</span>,</span>
<span>        <span class="co"># as above, we want to turn off drop and na.translate</span></span>
<span>        drop <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        na.translate <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span>,</span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  scale.date <span class="op">=</span> <span class="va">date_scale</span>,</span>
<span>  width.tree <span class="op">=</span> <span class="fl">20</span>,  <span class="co"># new: also specify the relative widths of the 4 columns:</span></span>
<span>  width.date <span class="op">=</span> <span class="fl">12</span>,  <span class="co">#</span></span>
<span>  width.legend <span class="op">=</span> <span class="fl">4</span>, <span class="co">#</span></span>
<span>  height.tree <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Duplicated `override.aes` is ignored.</span></span>
<span><span class="co">#&gt; Warning: Removed 28 rows containing non-finite outside the scale range</span></span>
<span><span class="co">#&gt; (`stat_week()`).</span></span>
<span><span class="co">#&gt; Warning: Duplicated `override.aes` is ignored.</span></span>
<span><span class="co">#&gt; Warning: Removed 11 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span>
<span><span class="co">#&gt; Warning: Removed 28 rows containing non-finite outside the scale range</span></span>
<span><span class="co">#&gt; (`stat_week()`).</span></span></code></pre></div>
<p><img src="phylepic_files/figure-html/unnamed-chunk-14-1.png" width="1056"></p>
<p>Each <code>plot.*</code> argument will normally be given a function
that is called with a single parameter: the phylepic object provided to
<code>plot</code>. The function must produce a ggplot object suitable
for aligning in the final chart.</p>
<p>For <code>plot.bars</code> in the above, we only wanted to override
the default options without adding any new custom layers. In common
cases like these we can reduce the boilerplate a bit:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">phydata</span>,</span>
<span>  plot.bars <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/plot_bars.html">plot_bars</a></span><span class="op">(</span></span>
<span>      <span class="va">x</span>,</span>
<span>      source <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html" class="external-link">scale_fill_hue</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># equivalent to the above</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">phydata</span>,</span>
<span>  plot.bars <span class="op">=</span> <span class="fu"><a href="../reference/plot_bars.html">plot_bars</a></span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html" class="external-link">scale_fill_hue</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This is because the <code>plot_*</code> helpers return a function
instead of a ggplot if their first parameter is omitted.</p>
</div>
<div class="section level3">
<h3 id="making-use-of-the-calendar-and-epidemic-curve">Making use of the calendar and epidemic curve<a class="anchor" aria-label="anchor" href="#making-use-of-the-calendar-and-epidemic-curve"></a>
</h3>
<p>The previous plot shows two clear genomic clusters associated with
concurrent outbreaks. To make this point more clearly, we would like to
indicate the two clusters on the epidemic curve (using the same colour
scale).</p>
<p>To achieve this, we pass <code>fill = cluster</code> to both the
<code>plot.epicurve</code> and <code>plot.calendar</code> panels:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">phydata</span>,</span>
<span>  plot.tree <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="../reference/plot_tree.html">plot_tree</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu">ggraph</span><span class="fu">::</span><span class="fu"><a href="https://ggraph.data-imaginist.com/reference/geom_node_point.html" class="external-link">geom_node_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>filter <span class="op">=</span> <span class="va">leaf</span>, colour <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="va">cluster_scale</span></span>
<span>  <span class="op">}</span>,</span>
<span>  plot.bars <span class="op">=</span> <span class="fu"><a href="../reference/plot_bars.html">plot_bars</a></span><span class="op">(</span></span>
<span>    source <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_hue.html" class="external-link">scale_fill_hue</a></span><span class="op">(</span></span>
<span>      name <span class="op">=</span> <span class="st">"Source"</span>, h.start <span class="op">=</span> <span class="fl">30</span>, drop <span class="op">=</span> <span class="cn">FALSE</span>, na.translate <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span>,</span>
<span>  <span class="op">)</span>,</span>
<span>  plot.epicurve <span class="op">=</span> <span class="fu"><a href="../reference/plot_epicurve.html">plot_epicurve</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="va">cluster</span><span class="op">)</span>,</span>
<span>  plot.calendar <span class="op">=</span> <span class="fu"><a href="../reference/plot_calendar.html">plot_calendar</a></span><span class="op">(</span></span>
<span>    fill <span class="op">=</span> <span class="va">cluster</span>,</span>
<span>    labels <span class="op">=</span> <span class="st">"%d"</span>,</span>
<span>  <span class="op">)</span>,</span>
<span>  scale.date <span class="op">=</span> <span class="va">date_scale</span>,</span>
<span>  scale.fill <span class="op">=</span> <span class="va">cluster_scale</span>, <span class="co"># new: pass the scale to both panels</span></span>
<span>  width.tree <span class="op">=</span> <span class="fl">20</span>,</span>
<span>  width.date <span class="op">=</span> <span class="fl">12</span>,</span>
<span>  width.legend <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  height.tree <span class="op">=</span> <span class="fl">6</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Duplicated `override.aes` is ignored.</span></span>
<span><span class="co">#&gt; Duplicated `override.aes` is ignored.</span></span>
<span><span class="co">#&gt; Warning: Removed 28 rows containing non-finite outside the scale range</span></span>
<span><span class="co">#&gt; (`stat_week()`).</span></span>
<span><span class="co">#&gt; Warning: Duplicated `override.aes` is ignored.</span></span>
<span><span class="co">#&gt; Duplicated `override.aes` is ignored.</span></span>
<span><span class="co">#&gt; Warning: Removed 11 rows containing missing values or values outside the scale range</span></span>
<span><span class="co">#&gt; (`geom_point()`).</span></span>
<span><span class="co">#&gt; Warning: Duplicated `override.aes` is ignored.</span></span>
<span><span class="co">#&gt; Warning: Removed 28 rows containing non-finite outside the scale range</span></span>
<span><span class="co">#&gt; (`stat_week()`).</span></span>
<span><span class="co">#&gt; Warning: Duplicated `override.aes` is ignored.</span></span></code></pre></div>
<p><img src="phylepic_files/figure-html/unnamed-chunk-16-1.png" width="1056"></p>
<p>Because the cluster colour scales are consistent across panels, the
legend guides are automatically combined.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Carl Suster.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
